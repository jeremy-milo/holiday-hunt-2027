<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>10. property</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Montserrat:wght@300;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="puzzle-style.css">
    
    <style>
        /* Specific Styles for Spirograph Game */
        #puzzle-stage {
            position: relative;
            z-index: 10;
            width: 100%;
            height: 50vh;
            max-height: 500px;
            background: rgba(0, 0, 0, 0.3);
            /* Original Gold Border Style */
            box-shadow: 0 0 0 4px #f6d365, 0 0 30px rgba(0,0,0,0.8);
            border-radius: 10px;
            overflow: hidden;
            touch-action: none;
            margin: 0 auto 20px auto; /* Explicitly centered */
        }

        .puzzle-layer {
            position: absolute;
            top: 50%; left: 50%;
            transform-origin: center center;
            cursor: grab;
            user-select: none;
            -webkit-user-drag: none;
            max-width: 85%;
            max-height: 85%;
            width: auto;
            height: auto;
        }

        .puzzle-layer:active { cursor: grabbing; }

        #layer-letters { z-index: 5; filter: drop-shadow(0 0 5px rgba(255,255,255,0.4)) brightness(1.2); }
        #layer-spiral { z-index: 10; opacity: 0.9; mix-blend-mode: exclusion; pointer-events: auto; }

        /* --- CONTROLS --- */
        #controls-area {
            position: relative;
            z-index: 10;
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(246, 211, 101, 0.2);
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 0 auto 30px auto; /* Explicitly centered */
        }

        .control-group { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .control-label { width: 70px; font-size: 0.9rem; text-align: left; color: #f6d365; font-weight: 600; }

        input[type="range"] {
            flex-grow: 1; height: 6px; background: rgba(255,255,255,0.2);
            border-radius: 3px; outline: none; -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 18px; height: 18px;
            background: #f6d365; border-radius: 50%; cursor: pointer;
            box-shadow: 0 0 5px rgba(246, 211, 101, 0.8);
        }

        /* Layer Selector */
        .layer-toggles { display: flex; justify-content: center; gap: 15px; margin-bottom: 5px; }
        .toggle-btn {
            padding: 8px 15px; background: transparent; border: 2px solid #f6d365;
            color: #f6d365; border-radius: 20px; cursor: pointer;
            font-family: 'Montserrat', sans-serif; font-weight: 600; transition: all 0.3s;
            font-size: 0.9rem;
        }
        .toggle-btn.active { background: #f6d365; color: #1b2735; box-shadow: 0 0 15px rgba(246, 211, 101, 0.4); }

        /* --- ANSWER INPUT --- */
        #answer-area {
            position: relative; z-index: 10; display: flex;
            flex-direction: column; align-items: center; width: 100%; margin: 0 auto 20px auto;
        }

        .win-text {
            font-family: 'Cinzel', serif; font-size: 2.5rem; color: #f6d365;
            margin-bottom: 30px; text-shadow: 0 0 20px #f6d365; text-align: center;
        }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <div class="container">
        <div class="puzzle-box">
            <h1>Puzzle 10: Spirographic</h1>
            <p class="instructions">
                The mechanism is misaligned. Use the controls to rotate, resize, and move the objects until alignment is achieved.  Only then will the message be revealed.
            </p>

            <!-- Puzzle Stage -->
            <div id="puzzle-stage">
                <!-- Note: Ensure 'code.png' and 'key.png' exist in your directory -->
                <img src="code.png" id="layer-letters" class="puzzle-layer" alt="Code file">
                <img src="key2.png" id="layer-spiral" class="puzzle-layer" alt="Key file">
            </div>

            <!-- Controls -->
            <div id="controls-area">
                <div class="layer-toggles">
                    <button class="toggle-btn" id="btn-letters" onclick="selectLayer('letters')">Code file</button>
                    <button class="toggle-btn active" id="btn-spiral" onclick="selectLayer('spiral')">Key file</button>
                </div>
                <div class="control-group">
                    <span class="control-label">Rotation</span>
                    <input type="range" id="input-rotation" min="0" max="360" value="0">
                </div>
                <div class="control-group">
                    <span class="control-label">Size</span>
                    <input type="range" id="input-scale" min="0.2" max="3.0" step="0.01" value="1">
                </div>
            </div>

            <!-- Answer Input -->
            <div id="answer-area">
                <input type="text" id="player-guess" class="answer-input" placeholder="Enter the secret message...">
                <button class="btn-style" onclick="checkAnswer()">Unlock</button>
            </div>
            
            <!-- Win Modal (Initially Hidden) -->
            <div id="win-modal" class="ui-layer hidden-ui">
                <div class="win-text">Alignment Complete</div>
                <button class="btn-style" id="next-btn" onclick="goNext()">Proceed</button>
            </div>
        </div>

        <div class="spacer-large"></div>
        <div class="hidden-clue">10. property</div>
    </div>

    <script>
        const layers = {
            letters: { el: document.getElementById('layer-letters'), x: 0, y: 0, rot: 0, scale: 1, rotOffset: 0, scaleOffset: 1 },
            spiral: { el: document.getElementById('layer-spiral'), x: 0, y: 0, rot: 0, scale: 1, rotOffset: 0, scaleOffset: 1 }
        };
        let activeLayerId = 'spiral'; const stage = document.getElementById('puzzle-stage');
        const rangeRot = document.getElementById('input-rotation'); const rangeScale = document.getElementById('input-scale');
        const btnLetters = document.getElementById('btn-letters'); const btnSpiral = document.getElementById('btn-spiral');

        function init() {
            randomizeLayer(layers.letters); randomizeLayer(layers.spiral);
            updateInputs(); applyTransforms('letters'); applyTransforms('spiral');
        }
        function randomizeLayer(layerObj) {
            layerObj.x = (Math.random() * 300) - 150; layerObj.y = (Math.random() * 200) - 100;
            layerObj.rotOffset = Math.floor(Math.random() * 360); layerObj.scaleOffset = 0.8 + (Math.random() * 0.4); 
            layerObj.rot = Math.floor(Math.random() * 360); layerObj.scale = 0.5 + (Math.random() * 1.5); 
        }
        function selectLayer(id) {
            activeLayerId = id;
            if(id === 'letters') { btnLetters.classList.add('active'); btnSpiral.classList.remove('active'); } 
            else { btnSpiral.classList.add('active'); btnLetters.classList.remove('active'); }
            updateInputs();
        }
        function updateInputs() { const l = layers[activeLayerId]; rangeRot.value = l.rot; rangeScale.value = l.scale; }
        function applyTransforms(id) {
            const l = layers[id]; const visualRot = (l.rot + l.rotOffset) % 360; const visualScale = l.scale * l.scaleOffset;
            l.el.style.transform = `translate(calc(-50% + ${l.x}px), calc(-50% + ${l.y}px)) rotate(${visualRot}deg) scale(${visualScale})`;
        }
        rangeRot.addEventListener('input', (e) => { layers[activeLayerId].rot = parseInt(e.target.value); applyTransforms(activeLayerId); });
        rangeScale.addEventListener('input', (e) => { layers[activeLayerId].scale = parseFloat(e.target.value); applyTransforms(activeLayerId); });

        let isDragging = false; let startX, startY; let initialLayerX, initialLayerY; let draggedLayerId = null;
        stage.addEventListener('mousedown', startDrag); stage.addEventListener('touchstart', startDrag, {passive: false});
        document.addEventListener('mousemove', drag); document.addEventListener('touchmove', drag, {passive: false});
        document.addEventListener('mouseup', endDrag); document.addEventListener('touchend', endDrag);

        function startDrag(e) {
            if (e.target.classList.contains('puzzle-layer')) {
                e.preventDefault(); isDragging = true;
                draggedLayerId = (e.target.id === 'layer-letters') ? 'letters' : 'spiral';
                selectLayer(draggedLayerId);
                const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
                startX = clientX; startY = clientY;
                initialLayerX = layers[draggedLayerId].x; initialLayerY = layers[draggedLayerId].y;
            }
        }
        function drag(e) {
            if (!isDragging) return; e.preventDefault(); 
            const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
            const dx = clientX - startX; const dy = clientY - startY;
            layers[draggedLayerId].x = initialLayerX + dx; layers[draggedLayerId].y = initialLayerY + dy;
            applyTransforms(draggedLayerId);
        }
        function endDrag() { isDragging = false; draggedLayerId = null; }

        const _k = [72, 97, 112, 112, 121, 32, 78, 101, 119, 32, 89, 101, 97, 114];
        function checkAnswer() {
            const input = document.getElementById('player-guess'); const val = input.value.trim(); 
            let keyStr = ""; for(let i=0; i<_k.length; i++) keyStr += String.fromCharCode(_k[i]);
            if (val.toLowerCase() === keyStr.toLowerCase()) { 
                const ui = document.getElementById('win-modal'); ui.classList.remove('hidden-ui'); ui.classList.add('active-ui');
            } else {
                input.style.borderColor = "#ff4444";
                input.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-10px)' }, { transform: 'translateX(10px)' }, { transform: 'translateX(0)' }], { duration: 400 });
                setTimeout(() => input.style.borderColor = "#f6d365", 1000);
            }
        }
        const _n = [49, 49, 45, 99, 97, 115, 101, 46, 104, 116, 109, 108];
        function goNext() {
            let nextUrl = ""; for(let i=0; i<_n.length; i++) nextUrl += String.fromCharCode(_n[i]);
            try { window.location.href = nextUrl; } catch(e) { const btn = document.getElementById('next-btn'); btn.innerText = "Redirecting..."; const a = document.createElement('a'); a.href = nextUrl; a.click(); }
        }
        
        /* --- SNOW ANIMATION (Harmonized) --- */
        const canvas = document.getElementById("snow-canvas");
        const ctx = canvas.getContext("2d");
        let width = window.innerWidth;
        let height = window.innerHeight;
        canvas.width = width;
        canvas.height = height;

        const particles = [];
        const particleCount = 100;

        class Particle {
            constructor() {
                this.x = Math.random() * width;
                this.y = Math.random() * height;
                this.radius = Math.random() * 3 + 1;
                this.speedY = Math.random() * 1 + 0.5;
                this.speedX = Math.random() * 0.5 - 0.25;
                this.opacity = Math.random() * 0.5 + 0.3;
            }
            update() {
                this.y += this.speedY;
                this.x += this.speedX;
                if (this.y > height) this.y = 0;
                if (this.x > width) this.x = 0;
                if (this.x < 0) this.x = width;
            }
            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
                ctx.fill();
            }
        }

        for (let i = 0; i < particleCount; i++) {
            particles.push(new Particle());
        }

        function animate() {
            ctx.clearRect(0, 0, width, height);
            particles.forEach(p => {
                p.update();
                p.draw();
            });
            requestAnimationFrame(animate);
        }
        animate();

        window.addEventListener('resize', () => {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        });

        init();
    </script>
</body>
</html>
